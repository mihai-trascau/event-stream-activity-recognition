%% print_trigger(_/_).
print_trigger(all_defined_events).

/*
    ETALIS FLAGS - big no no in an event file
*/
%% set_etalis_flags(store_fired_events,on).
%% set_etalis_flag(logging_to_file,on).

/*
    CONTEXT FLAGS
*/

score_compute_flag(mean).
%% score_compute_flag(min).

default_rule_window(5).

/*
    UTILTIES
*/

%% aggr_score(+score1, +score2, -Res)
%% Returns average of the two scores
aggr_score(Score1, Score2, Res) :- score_compute_flag(mean), Res is (Score1+Score2)/2.

%% aggr_score(+score1, +score2, -Res)
%% Returns the minimum of the two scores
aggr_score(Score1, Score2, Res) :- score_compute_flag(min), Res is min(Score1,Score2).

/*
    CONTEXT MANAGEMENT RULES
*/

%% Composition of pos(+Location,meta(+LastUpdate,+Confidence)) events
pos_score_diff_threshold(0.3).

r_pos_1 'rule:' pos(X, meta(T2, Score))
    <- pos(X,meta(T1,Score1)) 'seq' pos(X,meta(T2, Score2)) 
        'where' (
            pos_score_diff_threshold(Thresh),
            abs(Score1 - Score2) < Thresh,
            aggr_score(Score1,Score2,Score),
            retract(pos(X,meta(T1,Score1))),
            retract(pos(X,meta(T2,Score2)))
        ).

r_pos_2 'rule:' noop_event
    <- pos(X,meta(T1,Score1))) 'during' pos(X,meta(T, Score))
        'where' (
            retract(pos(X,meta(T1,Score1)))
        ).

event_rule_property(r_pos_1,event_rule_window,5).
event_rule_property(r_pos_2,event_rule_window,5).



%% Composition of lla(+LowLevelActivity,meta(+LastUpdate,+Confidence)) events
lla_score_diff_threshold(0.3).

r_lla_1 'rule:' lla(X, meta(T2, Score))
    <- lla(X,meta(T1,Score1)) 'seq' lla(X,meta(T2, Score2)) 
        'where' (
            lla_score_diff_threshold(Thresh),
            abs(Score1 - Score2) < Thresh,
            aggr_score(Score1,Score2,Score),
            retract(lla(X,meta(T1,Score1))),
            retract(lla(X,meta(T2,Score2)))
        ).

r_lla_2 'rule:' noop_event
    <- lla(X,meta(T1,Score1))) 'during' lla(X,meta(T, Score))
        'where' (
            retract(lla(X,meta(T1,Score1)))
        ).

event_rule_property(r_lla_1,event_rule_window,5).
event_rule_property(r_lla_2,event_rule_window,5).

/*
    DOMAIN RULES
*/

%% TU DU TU DU TUDU TUDU TUDU TUDU TUDUUUUUUUUUU